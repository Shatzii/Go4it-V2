# Go4It Sports Traffic Optimization for Nginx
# Optimized for peak traffic in mornings and afternoons

# Define time-based variables
map $time_iso8601 $peak_time {
    # Morning peak (6:00 AM to 11:00 AM)
    ~^[0-9]{4}-[0-9]{2}-[0-9]{2}T0[6-9]:[0-9]{2}:[0-9]{2} 1;
    ~^[0-9]{4}-[0-9]{2}-[0-9]{2}T10:[0-9]{2}:[0-9]{2} 1;
    
    # Afternoon peak (1:00 PM to 6:00 PM)
    ~^[0-9]{4}-[0-9]{2}-[0-9]{2}T1[3-8]:[0-9]{2}:[0-9]{2} 1;
    
    # Default off-peak
    default 0;
}

# Cache settings based on time of day
map $peak_time $cache_time {
    0 60m;    # Off-peak: 60 minute cache
    1 10m;    # Peak hours: 10 minute cache
}

# Rate limiting based on time of day
map $peak_time $request_rate {
    0 10r/s;  # Off-peak: 10 requests per second
    1 30r/s;  # Peak hours: 30 requests per second
}

map $peak_time $burst_rate {
    0 20;     # Off-peak: burst of 20
    1 60;     # Peak hours: burst of 60
}

# Define rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=$request_rate;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/s;

# Cache configuration
proxy_cache_path /var/cache/nginx/go4it_cache levels=1:2 keys_zone=go4it_cache:100m inactive=$cache_time max_size=10g;
proxy_cache_key "$scheme$request_method$host$request_uri";
proxy_cache_valid 200 302 $cache_time;
proxy_cache_valid 404 1m;
proxy_cache_lock on;
proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
proxy_cache_background_update on;

# Apply these settings to your server block
server {
    # Your existing server configuration...
    
    # API rate limiting (dynamic based on time)
    location /api/ {
        limit_req zone=api_limit burst=$burst_rate nodelay;
        
        # Other proxy settings...
        proxy_pass http://localhost:81/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache settings for API responses
        proxy_cache go4it_cache;
        proxy_cache_bypass $http_pragma $http_authorization;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Don't cache authenticated requests
        proxy_no_cache $http_authorization;
        proxy_cache_bypass $http_authorization;
        
        # Exclude specific API endpoints from caching
        location ~ ^/api/(login|logout|register|upload) {
            proxy_pass http://localhost:81;
            proxy_cache_bypass 1;
            proxy_no_cache 1;
        }
    }
    
    # Login rate limiting
    location ~ ^/api/(login|register) {
        limit_req zone=login_limit burst=10 nodelay;
        proxy_pass http://localhost:81;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # Cache static resources longer during peak times
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800, s-maxage=604800";
        add_header X-Cache-Status $upstream_cache_status;
        try_files $uri $uri/ /index.html;
    }
    
    # Upload endpoint - increase client body size for admin users
    location ~ ^/api/upload {
        client_max_body_size 2g;  # Allow up to 2GB uploads
        proxy_pass http://localhost:81;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 600s;  # 10 minutes timeout for large uploads
        client_body_timeout 600s;
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
}